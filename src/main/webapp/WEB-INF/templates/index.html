<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">    
    <head>
        <title>ATAVDB</title>

        <link rel="shortcut icon" type="image/x-icon" th:href="@{/img/favicon.ico}">        

        <!-- Franklin API CSS -->
        <link rel="stylesheet" type="text/css" href="https://s3.amazonaws.com/resources.genoox.com/assets/1.0/gnx-elements.css">

        <!-- datatables css start-->
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"/>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.bootstrap4.min.css"/>
        <!-- datatables css end-->

        <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
        <link rel="stylesheet" th:href="@{/css/all-fontawesome.css}">
        <link rel="stylesheet" th:href="@{/css/main.css}">

        <!-- load jQuery 3.4.1 -->
        <script type="text/javascript" th:src="@{/js/jquery-3.4.1.slim.min.js}"></script>
        <script type="text/javascript">
            var jQuery_3_4_1 = $.noConflict();
        </script>
        <script th:src="@{/js/popper.min.js}"></script>
        <script th:src="@{/js/bootstrap.min.js}"></script>

        <!-- datatables js start-->
        <!-- load jQuery 3.3.1 -->
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
        <script type="text/javascript">
            var jQuery_3_3_1 = $.noConflict();
        </script>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.bootstrap4.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
        <!-- datatables js end-->
    </head>

    <body>
        <div class="container">
            <div th:replace="fragments/header :: header"></div>

            <div class="container-main">
                <form id="form-search" class="form-search" th:action="@{/search}">
                    <div class="jumbotron" style="padding:20px 40px 20px 50px">
                        <h2>Data Browser 
                            <small>
                                <span class="badge badge-pill badge-secondary">hg19</span>
                            </small>
                        </h2>

                        <div class="row">
                            <div class="col-md-9 form-group">
                                <div class="input-group">
                                    <input id="query" name="query" class="form-control"
                                           type="text" placeholder="Search by variant, gene or region"
                                           th:value="${session.query}">
                                    <div class="input-group-append">
                                        <button id="btn-submit" class="btn btn-primary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>

                                <p class="text-muted" style="margin-left: 5px">
                                    Examples - 
                                    Variant: <a th:href="@{/variant/21-33040861-G-C}">21-33040861-G-C</a>,
                                    Gene: <a th:href="@{/gene/TBK1}">TBK1</a>,
                                    Region: <a th:href="@{/region/2:166892071-166893071}">2:166892071-166893071</a>


                                </p>
                            </div>

                            <div class="col-md-3 form-group text-center">
                                <div class="bg-light">
                                    <h2 th:text="${#numbers.formatDecimal(session.sampleCount,0,'COMMA',0,'POINT')}"></h2>
                                    <p><i class="fas fa-dna"></i> NGS Samples</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-row align-items-center">
                            <div class="col-md-auto form-group"
                                 data-toggle="tooltip" title="Search variants by selected phenotype">
                                <label for="input-select-phenotype">Phenotype:</label>
                                <select id="input-select-phenotype" name="phenotype" class="form-control"> 
                                    <option th:each="phenotype : ${session.phenotype_list}" th:value="${phenotype}" 
                                            th:text="${phenotype}" th:selected="${phenotype == session.phenotype}"></option>
                                </select>
                            </div>

                            <div class="col-md-auto form-group"
                                 data-toggle="tooltip" title="Search variants when its AF <= cutoff or AF >= (1 - cutoff)">
                                <label for="input-select-maf">MAF:</label>
                                <select id="input-select-maf" name="maf" class="form-control">
                                    <option th:each="maf : ${session.maf_list}" th:value="${maf}" 
                                            th:text="${maf}" th:selected="${maf == session.maf}"></option>
                                </select>
                            </div>

                            <div class="col-md-auto form-group">
                                <div class="custom-control custom-switch"
                                     data-toggle="tooltip" title="DP_bin >= 10; GQ >= 20; SNV-SOR <= 3; INDEL-SOR <= 10; 
                                     SNV-FS <= 60; INDEL-FS <= 200; MQ >= 40; QD >= 5; Qual >= 50; RPRS >= -3; 
                                     MQRS >= -10; FILTER = PASS or LIKELY or INTERMEDIATE">
                                    <input type="checkbox" class="custom-control-input" id="input-check-high-quality-variant" name="isHighQualityVariant"
                                           th:checked="${session.isHighQualityVariant}">
                                    <label class="custom-control-label" for="input-check-high-quality-variant">High Quality Variant</label>
                                </div>
                            </div>

                            <div class="col-md-auto form-group">
                                <div class="custom-control custom-switch"
                                     data-toggle="tooltip" title="All External AF are either 0 or NA">
                                    <input type="checkbox" class="custom-control-input" id="input-check-ultra-rare-variant" name="isUltraRareVariant"
                                           th:checked="${session.isUltraRareVariant}">
                                    <label class="custom-control-label" for="input-check-ultra-rare-variant">Ultra Rare Variant</label>
                                </div>
                            </div>

                            <div class="col-md-auto form-group">
                                <div class="custom-control custom-switch"
                                     data-toggle="tooltip" title="Available as control used samples in sequenceDB">
                                    <input type="checkbox" class="custom-control-input" id="input-check-public-available" name="isPublicAvailable"
                                           th:checked="${session.isPublicAvailable}">
                                    <label class="custom-control-label" for="input-check-public-available">Public Available Sample</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <th:block th:if="${session.query}">
                    <div class="row">
                        <div class="col">
                            <h4><mark>[[${session.queryType}]]: [[${session.query}]]</mark></h4>
                        </div>

                        <th:block th:if="${session.queryType == 'Variant'}" >
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://franklin.genoox.com/variant/snp/chr}+${session.query}" target="_blank">Franklin</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://gnomad.broadinstitute.org/variant/}+${session.query}" target="_blank">gnomAD</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{http://trap-score.org/Search(query=${session.query})}" target="_blank">TraP</a>
                            </div>
                            <th:block th:each = "variant : ${variantList}">
                                <div class="col-md-auto">
                                    <a class="btn btn-outline-secondary btn-sm" th:href="@{https://www.ncbi.nlm.nih.gov/clinvar/?term=({chr}[Chromosome] AND {pos}[Base Position for Assembly GRCh37])(chr = ${variant.getChrStr()}, pos = ${variant.getStartPosition()})}" target="_blank">ClinVar</a>
                                </div>
                                <div class="col-md-auto">
                                    <a class="btn btn-outline-secondary btn-sm" th:href="@{https://www.ncbi.nlm.nih.gov/snp/?term=({chr}[Chromosome] AND {pos}[Base Position Previous])(chr = ${variant.getChrStr()}, pos = ${variant.getStartPosition()})}" target="_blank">dbSNP</a>
                                </div>
                                <div class="col-md-auto">
                                    <a class="btn btn-outline-secondary btn-sm" th:href="@{http://myvariant.info/v1/variant/} + ${variant.getVariantIdStr2()} + @{?assembly=hg19&format=html}" target="_blank">MyVariant</a>
                                </div>
                                <div class="col-md-auto">
                                    <a class="btn btn-outline-secondary btn-sm" th:href="@{https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&position=chr}+${variant.getChrStr()}+${variant.getStartPosition()}+@{-}+${variant.getStartPosition()}" target="_blank">UCSC</a>
                                </div>
                            </th:block>
                        </th:block>

                        <th:block th:if="${session.queryType == 'Gene'}" >
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://decipher.sanger.ac.uk/gene/}+${session.query}" target="_blank">DECIPHER</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://grch37.ensembl.org/Homo_sapiens/Gene/Summary(g=${session.query})}" target="_blank">Ensembl</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://www.genecards.org/cgi-bin/carddisp.pl(gene=${session.query})}" target="_blank">GeneCards</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://www.genenames.org/tools/search/#!/genes(query=${session.query})}" target="_blank">HGNC</a>
                            </div>  
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{http://igmdx.org/Search(query=${session.query})}" target="_blank">IGMDx</a>
                            </div>  
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://omim.org/search(search=${session.query})}" target="_blank">OMIM</a>
                            </div>
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{http://genic-intolerance.org/Search(query=${session.query})}" target="_blank">RVIS</a>
                            </div>
                        </th:block>

                        <th:block th:if="${session.queryType == 'Region'}" >
                            <div class="col-md-auto">
                                <a class="btn btn-outline-secondary btn-sm" th:href="@{https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&position=chr}+${session.query}" target="_blank">UCSC</a>
                            </div>
                        </th:block>

                    </div>

                    <br/>
                    <br/>

                    <th:block th:if="${session.error}">
                        <div class="row">
                            <div class="col-auto">
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-circle"></i>&nbsp;[[${session.error}]]
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <th:block th:if="${message}">
                        <div class="row">
                            <div class="col-auto">
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-circle"></i>&nbsp;[[${message}]]
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <th:block th:if="${flankingRegion}">
                        <div class="row">
                            <div class="col-auto">
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-exclamation-circle"></i>&nbsp;
                                    Search by flanking region <a th:href="@{/region/}+${flankingRegion}">[[${flankingRegion}]]</a>
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <th:block th:if="${variantList != null and !variantList.isEmpty()}" >
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Variant</h4>

                                <div class='table-responsive'>
                                    <th:block th:with="variant_table=${session.queryType == 'Variant' ? '' : 'variant_table'}">                                        
                                        <table th:id="${variant_table}" class="table table-sm table-hover text-center">
                                            <thead>
                                                <tr>
                                                    <th class="align-middle" data-toggle="tooltip" title="chr-pos-ref-alt">Variant ID</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="HGVS_p or HGVS_c for most damaging effect (Ensemble 87)">Consequence</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Consequence type of this variation for most damaging effect (Ensemble 87)">Effect</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="HGNC gene for most damaging effect (Ensemble 87)">Gene</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Allele Acount">AC</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Allele Number (total number of alleles)">AN</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Allele Frequency">AF</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Number of samples having data">NS</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Number of homozygotes">NHOM</th>
                                                    <th class="align-middle" data-toggle="tooltip" title="Maximum External Allele Frequency">maxEAF</th>
                                                </tr>
                                            </thead>

                                            <tbody>
                                                <tr th:each="variant : ${variantList}">
                                                    <td class="align-middle">
                                                        <a th:href="@{/variant/}+${variant.getVariantIdStr()}" target='_blank'>
                                                            [[${variant.getVariantIdStr()}]]
                                                        </a>
                                                    </td>
                                                    <td class="align-middle">[[${variant.getConsequence()}]]</td>
                                                    <td class="align-middle">[[${variant.getEffect()}]]</td>
                                                    <td class="align-middle">[[${variant.getGeneName()}]]</td>
                                                    <td class="align-middle">[[${variant.getAC()}]]</td>
                                                    <td class="align-middle">[[${variant.getAN()}]]</td>
                                                    <td class="align-middle">[[${variant.getAF()}]]</td>
                                                    <td class="align-middle">[[${variant.getNS()}]]</td>
                                                    <td class="align-middle">[[${variant.getNH()}]]</td>
                                                    <td class="align-middle">[[${variant.getMaxEAF()}]]</td>
                                                </tr>
                                                </c:forEach>
                                            </tbody>
                                        </table>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <br/>
                    <br/>

                    <th:block th:if="${session.queryType == 'Variant'}" th:each="variant : ${variantList}">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Annotation</h4>
                                <div class='table-responsive'>
                                    <table class="table table-sm table-hover text-center">
                                        <thead>
                                            <tr>
                                                <th class="align-middle" data-toggle="tooltip" title="Consequence type of this variation (Ensemble 87)">Effect</th>
                                                <th class="align-middle" data-toggle="tooltip" title="HGNC gene identifier (Ensemble 87)">Gene</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Transcript stable id (Ensemble 87)">Transcript</th>
                                                <th class="align-middle" data-toggle="tooltip" title="HGVS coding sequence name (Ensemble 87)">HGVS_c</th>
                                                <th class="align-middle" data-toggle="tooltip" title="HGVS protein sequence name (Ensemble 87)">HGVS_p</th>
                                                <th class="align-middle" data-toggle="tooltip" title="PolyPhen-2 HumDiv Classification for missense variants from Ensembl 87">PolyPhen</th>
                                            </tr>
                                        </thead>

                                        <tbody>    
                                            <tr th:each="annotation : ${variant.getAllAnnotation()}">
                                                <td class="align-middle">[[${annotation.getEffect()}]]</td>
                                                <td class="align-middle">[[${annotation.getGeneName()}]]</td>
                                                <td class="align-middle">[[${annotation.getStableId()}]]</td>
                                                <td class="align-middle">[[${annotation.getHGVS_c()}]]</td>
                                                <td class="align-middle">[[${annotation.getHGVS_p()}]]</td>
                                                <td class="align-middle">[[${annotation.getPolyphen()}]]</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <br/>
                        <br/>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">External AF</h4>
                                <div class='table-responsive'>
                                    <table class="table table-sm table-hover text-center">
                                        <thead>
                                            <tr>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 0.3">ExAC</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 2020-02-19">Genome Asia</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 2.1">gnomAD Exome</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 2.1">gnomAD Genome</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 2016-09-18">GME Variome</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version 2020-02-24">Iranome</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Version Freeze3a hg19">TOPMED</th>
                                            </tr>
                                        </thead>

                                        <tbody>    
                                            <tr>
                                                <td class="align-middle">[[${variant.getExAC()}]]</td>
                                                <td class="align-middle">[[${variant.getGenomeAsia()}]]</td>
                                                <td class="align-middle">[[${variant.getGnomADExome()}]]</td>
                                                <td class="align-middle">[[${variant.getGnomADGenome()}]]</td>
                                                <td class="align-middle">[[${variant.getGME()}]]</td>
                                                <td class="align-middle">[[${variant.getIranme()}]]</td>
                                                <td class="align-middle">[[${variant.getTopMed()}]]</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <br/>
                        <br/>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Carrier</h4>

                                <div class="row mt-2">
                                    <div class="col-md-auto lead"><span class="badge badge-light">Gender count:</span></div>
                                    <div class="col-md-auto lead" th:each="gender : ${session.genders}">
                                        <span class="badge badge-light" th:text="${variant.getGenderCount()[gender.getIndex()]}+${' '}+${gender.getName()}"></span> 
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <div class="col-md-auto lead"><span class="badge badge-light">Ancestry count:</span></div>
                                    <div class="col-md-auto lead" th:each="ancestry : ${session.ancestries}">
                                        <span class="badge badge-light" th:text="${variant.getAncestryCount()[ancestry.getIndex()]}+${' '}+${ancestry.getName()}"></span> 
                                    </div>
                                </div>

                                <br/>

                                <div th:if="${variant.getCarriers() != null}" class='table-responsive'>
                                    <table id="carrier_table" class="table table-sm table-hover text-center">
                                        <thead>
                                            <tr>
                                                <th th:if="${session.sequence_authorized}" class="align-middle" data-toggle="tooltip" title="Sample experiment_id in sequenceDB">Experiment ID</th>
                                                <th class="align-middle" data-toggle="tooltip" title="AvaiContUsed in sequenceDB">Public Available</th>
                                                <th class="align-middle" data-toggle="tooltip" title="seqGender in sequenceDB">Gender</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Broad Phenotype in sequenceDB">Phenotype</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Ancestry probability >= 0.5 in sequenceDB">Ancestry</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Genotype">GT</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Read Depth">DP</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Percentage of all the reads at the site that support the alternative allele">Percent Alt Read</th>
                                                <th class="align-middle" data-toggle="tooltip" title="Genotype Quality">GQ</th>
                                                <th class="align-middle" data-toggle="tooltip" title="PASS->PASS, VQSRTrancheSNP90.00to99.00->LIKELY, VQSRTrancheSNP99.00to99.90->INTERMEDIATE, VQSRTrancheSNP99.90to100.00->FAIL">FILTER</th>
                                            </tr>
                                        </thead>
                                        <tbody>                             
                                            <tr th:each="carrier : ${variant.getCarriers()}">
                                                <td th:if="${session.sequence_authorized}" class="align-middle">
                                                    <a th:href="@{https://sequence.igm.cumc.columbia.edu/search.php?action=viewSample&experiment_id=}+${carrier.getExperimentId()}" target="_blank">
                                                        [[${carrier.getExperimentId()}]]
                                                    </a>
                                                </td>
                                                <td class="align-middle">[[${carrier.getAvailableControlUse()}]]</td>
                                                <td class="align-middle">[[${carrier.getGender()}]]</td>
                                                <td class="align-middle">[[${carrier.getPhenotype()}]]</td>
                                                <td class="align-middle">[[${carrier.getAncestry()}]]</td>
                                                <td class="align-middle">[[${carrier.getGTStr()}]]</td>
                                                <td class="align-middle">[[${carrier.getDP()}]]</td>
                                                <td class="align-middle">[[${carrier.getPercAltRead()}]]</td>
                                                <td class="align-middle">[[${carrier.getGQ()}]]</td>
                                                <td class="align-middle">[[${carrier.getFILTER()}]]</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div th:if="${variant.getCarriers() == null}" class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-circle"></i>&nbsp;
                                    <strong>Not displaying carriers data when AF > 0.01</strong>
                                </div>
                            </div>
                        </div>

                        <br/>
                        <br/>

                        <gnx-summary></gnx-summary>
                        <script src="https://s3.amazonaws.com/resources.genoox.com/assets/1.0/gnx-elements.js"></script>
                        <script type="text/javascript">
                            let elem = document.querySelector('gnx-summary');
                            elem.variantId = {
                            ref: '[[${variant.getRef()}]]',
                                    alt: '[[${variant.getAlt()}]]',
                                    chr: '[[${variant.getChrStr()}]]',
                                    pos: [[${variant.getStartPosition()}]],
                            };
                        </script>
                    </th:block>
                </th:block> 

                <br/>

                <div th:replace="fragments/footer :: footer"></div>
                <div th:replace="fragments/counter :: counter"></div>
            </div>

            <script type='text/javascript'>
                jQuery_3_4_1(document).ready(function () {
                jQuery_3_4_1('#form-search').submit(function () {
                jQuery_3_4_1("#btn-submit").prop("disabled", true);
                jQuery_3_4_1("#btn-submit").html(
                        `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`
                        );
                jQuery_3_4_1("#input-select-phenotype").filter(
                        function () {
                        return !this.value;
                        }
                ).prop("disabled", true);
                jQuery_3_4_1("#input-select-max-af").filter(
                        function () {
                        return !this.value;
                        }
                ).prop("disabled", true);
                jQuery_3_4_1("#input-check-high-quality-variant").filter(
                        function () {
                        return !this.value;
                        }
                ).prop("disabled", true);
                return true;
                });
                });
                jQuery_3_3_1(document).ready(function () {
                var variant_table = jQuery_3_3_1('#variant_table').DataTable({
                buttons: [
                {
                extend: 'csv',
                        text: '<i class="fas fa-file-csv"></i> Download',
                        className: 'btn btn-light'
                },
                ],
                });
                variant_table.buttons().container().appendTo('#variant_table_wrapper .col-md-6:eq(0)');
                var carrier_table = jQuery_3_3_1('#carrier_table').DataTable({
                });
                carrier_table.buttons().container().appendTo('#carrier_table_wrapper .col-md-6:eq(0)');
                });
                jQuery_3_4_1(function () {
                jQuery_3_4_1('[data-toggle="tooltip"]').tooltip({boundary: 'window'});
                });
            </script> 
    </body>
</html>